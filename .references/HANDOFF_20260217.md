# AI-PMIS 대시보드 프로젝트 핸드오프 문서
> **마지막 업데이트**: 2026-02-18 17:40 KST  
> **Git**: https://github.com/bignine99/ai_pmis.git (main 브랜치)  
> **파일 위치**: `c:\Users\cho\Desktop\Temp\05 Code\260216_evms_dashborad\`  
> **캐시 버전**: 모든 CSS/JS 파일은 `?v=29`

---

## 1. 프로젝트 개요

**EVMS(Earned Value Management System) 건설사업관리 종합 대시보드**
- 소방학교 신축공사 프로젝트의 원가·공정·물량·조직·기성·생산성을 시각화하는 SPA(Single Page Application)
- 순수 HTML + JavaScript + CSS로 구성 (프레임워크 없음)
- SQLite DB를 브라우저에서 sql.js로 직접 로드하여 쿼리
- Gemini 2.5 Flash-Lite API를 통한 자연어 → SQL 변환 AI 분석 기능

---

## 2. 기술 스택

| 구분 | 기술 |
|------|------|
| 프론트엔드 | HTML5, Vanilla JS (ES5 호환), CSS3 |
| 차트 | Chart.js |
| DB | sql.js (SQLite in browser) |
| UI 프레임워크 | Bootstrap 5 (그리드/유틸리티만), Font Awesome 6.5 |
| 폰트 | Inter, Noto Sans KR, JetBrains Mono |
| AI | Gemini 2.5 Flash-Lite API (NL→SQL) |
| 호스팅 | 정적 파일 (file:// 프로토콜로 로컬 실행 가능) |

---

## 3. 파일 구조

```
260216_evms_dashborad/
├── index.html              # 메인 HTML (SPA 진입점)
├── css/
│   └── style.css           # 전체 스타일 (~2,100줄)
├── js/
│   ├── app.js              # 메인 앱 (라우터, 테마, 사이드바)
│   ├── components.js       # 공통 UI 컴포넌트
│   ├── router.js           # 해시 라우터
│   ├── db_modules.js       # SQLite DB 로드/쿼리 모듈
│   ├── ai_engine.js        # CUBE-AI NL2SQL 엔진 (~780줄)
│   ├── org_charts.js       # 조직도 차트
│   ├── outline_gantt.js    # Gantt 차트 렌더러
│   └── pages/
│       ├── overview.js     # 프로젝트 개요
│       ├── cost.js         # 원가 분석
│       ├── schedule.js     # 공정 관리 (Gantt)
│       ├── quantity.js     # 물량 분석
│       ├── organization.js # 조직 관리
│       ├── evms.js         # EVMS 기성 분석
│       ├── productivity.js # 생산성 분석
│       ├── ai_analysis.js  # AI 분석 페이지 (~780줄)
│       └── cube_view.js    # CUBE View
├── output/
│   ├── project_db.sqlite   # 운영 DB (evms 테이블)
│   ├── planned_schedule.pdf
│   ├── quarter_schedule.html
│   └── week_schedule.html
├── .project_info/           # 프로젝트 이미지/사업개요
├── .raw_db/                 # 원본 CSV, DB 생성 스크립트
├── *.py                     # DB 생성/검증 Python 스크립트
├── *.md                     # 문서 (매뉴얼, 개발가이드)
└── .gitignore
```

---

## 4. DB 스키마 (evms 테이블)

```
| 컬럼명                  | 설명                |
|------------------------|---------------------|
| code                   | 항목 코드            |
| WHERE1_프로젝트         | 프로젝트명           |
| WHERE2_동              | 동 구분              |
| WHERE3_층              | 층 구분              |
| HOW1_공사              | 공사 구분 (건축/토목/기계/전기) |
| HOW2_대공종            | 대공종               |
| HOW3_작업명            | 세부 작업명           |
| HOW4_품명              | 품명                 |
| HOW5_규격              | 규격                 |
| HOW6_세부작업명         | 세부작업명            |
| WHEN1_시작일           | 공정 시작일           |
| WHEN2종료일            | 공정 종료일           |
| WHEN3_기간(일)         | 공정 기간(일수)       |
| WHO1_하도급업체         | 하도급업체명          |
| R1_단위                | 수량 단위            |
| R2_수량                | 수량                 |
| R3_재료비_단가          | 재료비 단가           |
| R4_노무비_단가          | 노무비 단가           |
| R5_경비_단가            | 경비 단가             |
| R6_합계_단가            | 합계 단가             |
| R7_재료비_금액          | 재료비 금액           |
| R8_노무비_금액          | 노무비 금액           |
| R9_경비_금액            | 경비 금액             |
| R10_합계_금액           | 합계 금액 (총 공사비)  |
```

---

## 5. AI 분석 기능 (ai_engine.js + ai_analysis.js)

### 5.1 아키텍처
```
사용자 질문
    ↓
[normalizeQuestion] 건설 구어체 → 표준 용어 변환
    ↓
[CONFIG.apiKey 존재?]
    ├── YES → callGeminiAPI() → Gemini 2.5 Flash-Lite
    │         (실패 시 → gemini-2.5-flash → gemini-2.0-flash 순으로 폴백)
    └── NO  → fallbackEngine() → 프리셋 매칭 (28개)
                                   └── smartFallback() → 동적 SQL 생성
```

### 5.2 Gemini API 설정
- **모델**: `gemini-2.5-flash-lite`
- **엔드포인트**: `https://generativelanguage.googleapis.com/v1beta/models/`
- **temperature**: 0.1 (정확성 우선)
- **responseMimeType**: 제거됨 (호환성 문제로)
- **JSON 추출**: 3단계 (```json 블록 → { } 직접 → 텍스트)
- **모델 폴백**: 404/429 시 자동으로 다음 모델 시도

### 5.3 건설 구어체 동의어 (SYNONYMS 배열)
```
공구리/곤구리/꽁구리 → 콘크리트
아시바/비게 → 비계
빠루 → 바, 몽키 → 렌치
생콘 → 레미콘
뿌리방/뿌림방 → 기초공사
타설 → 콘크리트, 물량 → 수량
대금/공사비/돈 → 금액
비용/지급/청구 → 금액/기성
자재 → 재료, 인부 → 노무
```

### 5.4 현재 상태 — 모두 완료
- ✅ API 키 모달: 인라인 스타일로 "연결" 버튼 보이도록 수정 완료
- ✅ Enter 키로도 API 키 저장 가능
- ✅ 채팅 메시지: 사용자 질문 + AI 응답 모두 표시됨
- ✅ API 에러 시 상세 에러 메시지 채팅에 표시
- ✅ **Gemini API 연동 완료**: `responseMimeType` 제거, JSON 파싱 3단계 적용, 모델 폴백(flash-lite → 2.5-flash → 2.0-flash) 동작 확인
- ✅ **구어체 사전 확장 완료**: 현장 비속어 목록(`.raw_db/현장대표비속어.txt`) 반영, `SYNONYMS` 배열 확장
- ✅ **AI 응답 캔버스 렌더링 완료**: Summary/Grid/Chart 탭 정상 동작
- ✅ **CUBE View 필터/차트 기능 완료**: 필터 컨트롤, 동적 필터 값 로딩, 5종 차트 유형 지원

---

## 6. 페이지별 기능 현황

| 페이지 | 라우트 | 상태 | 주요 기능 |
|--------|--------|------|-----------|
| 프로젝트 개요 | `#overview` | ✅ 완료 | KPI 카드, 공사 분류별 비용 차트, 프로젝트 정보 |
| 원가 분석 | `#cost` | ✅ 완료 | 공종별/업체별 원가, 재료비/노무비/경비 분석 |
| 공정 관리 | `#schedule` | ✅ 완료 | Gantt 차트 (전체/분기/주간/마일스톤), 다이아몬드 마일스톤 |
| 물량 분석 | `#quantity` | ✅ 완료 | 동별/층별/공종별 물량, 필터링 |
| 조직 관리 | `#organization` | ✅ 완료 | 조직도, 업체별 공사비, 인력 현황 |
| EVMS 기성 | `#evms` | ✅ 완료 | EV/PV/AC 분석, S-Curve |
| 생산성 | `#productivity` | ✅ 완료 | 업체별 생산성, 효율 분석 |
| AI 분석 | `#ai-analysis` | ✅ 완료 | 자연어 질의(Gemini NL→SQL), 차트 자동 생성, 28개 프리셋, 구어체 변환 |
| CUBE View | `#cube-view` | ✅ 완료 | 6W1H 다차원 피벗 분석, 필터 컨트롤, 5종 차트(막대/가로/누적/꺾은선/도넛) |

---

## 7. Gantt 차트 특이사항 (schedule.js)

- **HOW3_작업명**을 활동 이름으로 사용 (모든 간트 차트에서)
- **마일스톤**: 다이아몬드 마커(◆)로 표시, 기간 = 0
  - 착공, 토공완료, 골조상량, 수전/시운전, 준공
  - 마일스톤 날짜는 DB에서 관련 데이터를 기반으로 추출
- **분기별/주간 간트**: 자동 업데이트, 날짜 범위 계산

---

## 8. CSS 구조 (style.css ~2,100줄)

### 주요 섹션
- `:root` 변수 (라이트/다크 테마)
- 사이드바 + 콘텐츠 레이아웃
- 카드, KPI, 차트 스타일
- AI 분석 전용 스타일 (`.ai-*` 클래스, 1100줄~)
  - `.ai-layout`: 좌(30%) 채팅 + 우(70%) 캔버스 flex 레이아웃
  - `.ai-chat-panel`: 채팅 패널 (min-height:150px)
  - `.ai-chips-area`: 프리셋 칩 영역 (max-height:160px)
  - `.ai-modal-overlay`: API 키 모달 (document.body에 직접 추가)
- 반응형 미디어 쿼리

### AI 페이지 CSS 특이사항
- `.content-wrapper.ai-page-active`는 padding:0, overflow:hidden
- 모달은 `document.body`에 직접 추가 (overflow:hidden 회피)
- 모달 버튼은 **인라인 스타일**로 렌더링 (Bootstrap 충돌 방지)

---

## 9. 외부 의존성 (CDN)

```html
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<!-- Font Awesome 6 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
<!-- sql.js (SQLite in browser) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.min.js">
```

---

## 10. 완료된 작업 히스토리

### 2026-02-18 (최종 완료)
- ✅ Gemini API 연동 테스트 완료 — JSON 파싱 및 모델 폴백 정상 동작
- ✅ AI 응답 결과 Summary/Grid/Chart 캔버스 렌더링 완료
- ✅ 건설 구어체 사전 확장 완료 — 현장 비속어 목록 `SYNONYMS` 배열에 반영
- ✅ AI 분석 UX 개선 완료 — 채팅 메시지, 에러 처리 정상
- ✅ CUBE View에 필터 컨트롤, 동적 필터 값 로딩, 5종 차트 유형 추가

### 2026-02-17
- ✅ API 키 모달 수정 (인라인 스타일, Enter 키 지원)
- ✅ Gemini 모델 폴백 구현 (flash-lite → 2.5-flash → 2.0-flash)
- ✅ responseMimeType 제거 및 JSON 추출 3단계 구현
- ✅ DB v20260217 생성 (하도급업체 컬럼 추가)

### 2026-02-16
- ✅ Gantt 차트 마일스톤 다이아몬드 마커(◆) 구현
- ✅ HOW3_작업명 기준 활동 이름 표시
- ✅ 하도급업체 데이터 할당 (step6_evms01.csv)

> **🎉 모든 개발 작업 완료 (9개 페이지 전체 정상 동작)**

---

## 11. 알려진 기술적 주의사항

1. **캐시**: 파일 수정 후 반드시 `index.html`의 `?v=` 번호를 올려야 함 (현재 `v=29`)
2. **CORS**: `file://` 프로토콜에서 Gemini API 호출 시 CORS 문제 없음 (브라우저가 허용)
3. **Bootstrap 충돌**: Bootstrap CSS가 커스텀 버튼 스타일을 덮어쓸 수 있음 → 인라인 스타일 또는 `!important` 사용
4. **DB 로드**: `output/project_db.sqlite`를 xhr로 로드 → `file://`에서는 Chrome의 `--allow-file-access-from-files` 플래그 필요할 수 있음
5. **모달**: API 키 모달은 `document.body`에 직접 추가됨 → 페이지 이탈 시 `cleanupAiPage()`에서 제거
6. **로컬 서버**: `python -m http.server 8080` 명령으로 로컬 서버 실행 후 `http://localhost:8080`에서 접속 가능

---

## 12. Git 정보

```bash
# 클론
git clone https://github.com/bignine99/ai_pmis.git

# 현재 상태
- 브랜치: main
- 최신 커밋: 05faad4 "Initial commit: AI-PMIS Dashboard"
- 46개 파일, 38,003줄

# .gitignore 제외 항목
.created_db/              # DB 백업
output/project_db_v2.sqlite  # 이전 버전 DB
output/project_db_v3.sqlite  # 이전 버전 DB
.agent/                   # 에이전트 디렉터리
.vscode/, .idea/          # IDE 설정
```

---

## 13. 빠른 시작 가이드

1. 프로젝트 폴더에서 `index.html`을 브라우저로 연다
2. 사이드바에서 원하는 페이지를 클릭하여 이동
3. **AI 분석** 사용 시:
   - ⚙️ 아이콘 클릭 → Gemini API 키 입력 → "연결" 클릭
   - 채팅창에 자연어로 질문 (예: "업체별 총 공사비는?")
   - 프리셋 칩 클릭으로도 질문 가능
